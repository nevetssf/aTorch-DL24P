<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Test Bench Help</title>
    <style>
        :root {
            --text: #1a1a2e;
            --text-secondary: #475569;
            --heading: #16213e;
            --heading-secondary: #1e3a5f;
            --accent: #3b82f6;
            --bg: #ffffff;
            --bg-alt: #f8fafc;
            --border: #e2e8f0;
            --code-bg: #f1f5f9;
            --code-text: #334155;
            --callout-warning-bg: #fef2f2;
            --callout-warning-border: #ef4444;
            --callout-warning-text: #991b1b;
            --callout-tip-bg: #f0fdf4;
            --callout-tip-border: #22c55e;
            --callout-tip-text: #166534;
            --callout-note-bg: #fffbeb;
            --callout-note-border: #f59e0b;
            --callout-note-text: #92400e;
            --callout-info-bg: #eff6ff;
            --callout-info-border: #3b82f6;
            --callout-info-text: #1e40af;
            --callout-problem-bg: #fef2f2;
            --callout-problem-border: #dc3545;
            --callout-solution-bg: #f0fdf4;
            --callout-solution-border: #22c55e;
            --table-header-bg: #f1f5f9;
            --table-border: #cbd5e1;
            --table-row-border: #e2e8f0;
            --toc-bg: #f8fafc;
            --toc-border: #e2e8f0;
            --footer-text: #94a3b8;
            --footer-link: #64748b;
            --h2-bg: linear-gradient(135deg, #eff6ff, #f0f9ff);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --text: #e2e8f0;
                --text-secondary: #94a3b8;
                --heading: #f1f5f9;
                --heading-secondary: #cbd5e1;
                --accent: #60a5fa;
                --bg: #0f172a;
                --bg-alt: #1e293b;
                --border: #334155;
                --code-bg: #1e293b;
                --code-text: #e2e8f0;
                --callout-warning-bg: #3b1114;
                --callout-warning-border: #ef4444;
                --callout-warning-text: #fca5a5;
                --callout-tip-bg: #0a2e1a;
                --callout-tip-border: #22c55e;
                --callout-tip-text: #86efac;
                --callout-note-bg: #2e1f05;
                --callout-note-border: #f59e0b;
                --callout-note-text: #fcd34d;
                --callout-info-bg: #0c1f3d;
                --callout-info-border: #3b82f6;
                --callout-info-text: #93c5fd;
                --callout-problem-bg: #3b1114;
                --callout-problem-border: #ef4444;
                --callout-solution-bg: #0a2e1a;
                --callout-solution-border: #22c55e;
                --table-header-bg: #1e293b;
                --table-border: #475569;
                --table-row-border: #334155;
                --toc-bg: #1e293b;
                --toc-border: #334155;
                --footer-text: #64748b;
                --footer-link: #94a3b8;
                --h2-bg: linear-gradient(135deg, #1e293b, #0f172a);
            }
        }

        * { box-sizing: border-box; }

        html { scroll-behavior: smooth; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Arial, sans-serif;
            line-height: 1.7;
            color: var(--text);
            background: var(--bg);
            max-width: 800px;
            margin: 0 auto;
            padding: 24px 32px 48px;
        }

        h1 {
            color: var(--heading);
            font-size: 28px;
            font-weight: 700;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 12px;
            margin: 0 0 8px;
        }

        h2 {
            color: var(--heading-secondary);
            font-size: 20px;
            font-weight: 600;
            margin-top: 36px;
            padding: 8px 12px;
            background: var(--h2-bg);
            border-left: 4px solid var(--accent);
            border-radius: 4px;
        }

        h3 {
            color: var(--heading);
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 8px;
        }

        a { color: var(--accent); }

        code {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Menlo, Consolas, monospace;
            font-size: 13px;
        }

        .callout {
            padding: 12px 16px;
            margin: 14px 0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .warning {
            background-color: var(--callout-warning-bg);
            border-left: 4px solid var(--callout-warning-border);
            color: var(--callout-warning-text);
        }

        .tip {
            background-color: var(--callout-tip-bg);
            border-left: 4px solid var(--callout-tip-border);
            color: var(--callout-tip-text);
        }

        .note {
            background-color: var(--callout-note-bg);
            border-left: 4px solid var(--callout-note-border);
            color: var(--callout-note-text);
        }

        .info {
            background-color: var(--callout-info-bg);
            border-left: 4px solid var(--callout-info-border);
            color: var(--callout-info-text);
        }

        .problem {
            background-color: var(--callout-problem-bg);
            border-left: 4px solid var(--callout-problem-border);
            color: var(--callout-warning-text);
        }

        .solution {
            background-color: var(--callout-solution-bg);
            border-left: 4px solid var(--callout-solution-border);
            color: var(--callout-tip-text);
        }

        ul { margin-left: 16px; padding-left: 8px; }
        li { margin: 6px 0; }
        ol li { margin: 8px 0; }
        b { color: var(--heading); }

        table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
        }

        th {
            background: var(--table-header-bg);
            padding: 8px 12px;
            text-align: left;
            border-bottom: 2px solid var(--table-border);
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 6px 12px;
            border-bottom: 1px solid var(--table-row-border);
            font-size: 13px;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 32px 0;
        }

        nav.toc {
            background: var(--toc-bg);
            border: 1px solid var(--toc-border);
            border-radius: 8px;
            padding: 16px 20px;
            margin: 20px 0 28px;
        }

        nav.toc h2 {
            margin: 0 0 8px;
            padding: 0;
            background: none;
            border-left: none;
            font-size: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        nav.toc ul {
            list-style: none;
            margin: 0;
            padding: 0;
            columns: 2;
            column-gap: 24px;
        }

        nav.toc li {
            margin: 4px 0;
            break-inside: avoid;
        }

        nav.toc a {
            text-decoration: none;
            font-size: 14px;
        }

        nav.toc a:hover { text-decoration: underline; }

        .footer {
            text-align: center;
            color: var(--footer-text);
            font-size: 13px;
            margin-top: 32px;
        }

        .footer a { color: var(--footer-link); }

        @media (max-width: 600px) {
            body { padding: 16px; }
            nav.toc ul { columns: 1; }
        }
    </style>
</head>
<body>
    <h1>Load Test Bench Help</h1>

    <nav class="toc">
        <h2>Contents</h2>
        <ul>
            <li><a href="#getting-started">Getting Started</a></li>
            <li><a href="#test-panels">Test Panels</a></li>
            <li><a href="#plots">Plots &amp; Live Data</a></li>
            <li><a href="#data">Data Management</a></li>
            <li><a href="#presets">Presets</a></li>
            <li><a href="#settings">Settings</a></li>
            <li><a href="#chemistry">Battery Chemistry</a></li>
            <li><a href="#specs">Technical Specs</a></li>
            <li><a href="#files">File Locations</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
        </ul>
    </nav>

    <div class="callout info">
        <b>Tested devices:</b> aTorch DL24 and DL24P electronic loads.
        See the <a href="https://atorch-electric.com/electronic-load-meter/">manufacturer's product page</a>
        for specifications and documentation. This software is an independent project with no affiliation
        with aTorch.
    </div>

    <!-- Getting Started -->

    <h2 id="getting-started">Getting Started</h2>

    <h3>Connecting to the DL24P</h3>
    <ol>
        <li>Connect the DL24P to your computer via USB</li>
        <li>The app auto-detects the device — click <b>Connect</b> in the Control Panel</li>
        <li>The status bar shows connection state and live voltage once communication is established</li>
    </ol>

    <div class="callout note">
        <b>macOS note:</b> After power-cycling the DL24P, the app may prompt for your password
        to send a one-time USB reset command. This is normal and only needed once per power cycle.
    </div>

    <div class="callout warning">
        <b>USB connection:</b> The DL24P may not be detected when plugged directly into a
        Thunderbolt port on Apple Silicon Macs. Connect it through a <b>USB hub</b> or dock's
        USB-A port instead — the hub handles the USB 2.0 speed negotiation the device requires.
    </div>

    <h3>Basic Controls</h3>
    <p>The Control Panel provides manual control of the electronic load:</p>
    <ul>
        <li><b>Mode:</b> CC (Constant Current), CP (Constant Power), CV (Constant Voltage), CR (Constant Resistance)</li>
        <li><b>Value:</b> Set the load value for the selected mode</li>
        <li><b>Voltage Cutoff:</b> Minimum voltage before the load automatically turns off</li>
        <li><b>Load On/Off:</b> Toggle the electronic load</li>
    </ul>

    <div class="callout warning">
        <b>Important:</b> Always set an appropriate voltage cutoff when testing batteries to prevent over-discharge damage.
    </div>

    <hr>

    <!-- Test Panels -->

    <h2 id="test-panels">Test Panels</h2>

    <h3>Battery Capacity</h3>
    <p>Discharges a battery at constant current and measures total capacity (mAh) and energy (Wh).</p>
    <ul>
        <li><b>Discharge Current:</b> Constant current draw (e.g., 1.0A)</li>
        <li><b>Voltage Cutoff:</b> Stop voltage (e.g., 3.0V for Li-Ion)</li>
        <li><b>Time Limit:</b> Optional maximum test duration</li>
        <li><b>Battery Info:</b> Document the battery name, chemistry, rated capacity, etc.</li>
    </ul>
    <p><b>Use for:</b> Measuring actual capacity, verifying specs, comparing brands, tracking degradation.</p>

    <div class="callout tip">
        <b>Tip:</b> Use presets for common battery types (Canon, Nikon, Eneloop, etc.) to quickly set up tests.
        Use 0.5C or lower discharge rate for the most accurate capacity readings.
    </div>

    <h3>Battery Load</h3>
    <p>Steps through load levels to characterize how battery voltage responds under different loads.</p>
    <ul>
        <li><b>Load Type:</b> Current, Power, or Resistance sweep</li>
        <li><b>Min/Max:</b> Load range to test (e.g., 0.5A to 3A)</li>
        <li><b>Steps:</b> Number of measurement points</li>
        <li><b>Dwell Time:</b> Settling time at each level for stable readings</li>
    </ul>
    <p><b>Use for:</b> Measuring internal resistance, evaluating high-drain performance, comparing battery health.</p>

    <h3>Battery Charger</h3>
    <p>Simulates battery voltage levels using CV mode and measures the charger's current output,
    revealing the CC-CV charging profile.</p>
    <ul>
        <li><b>Chemistry:</b> Determines voltage range (Li-Ion 1S/2S/3S, NiMH, LiFePO4)</li>
        <li><b>Voltage Range:</b> Simulated battery voltage from depleted to full</li>
        <li><b>Steps / Dwell:</b> Resolution and settling time</li>
    </ul>
    <p><b>Setup:</b> Connect charger output to DL24P input. The DL24P acts as a simulated battery.</p>
    <p><b>Use for:</b> Verifying charger specs, comparing charging profiles, identifying counterfeits.</p>

    <hr>

    <!-- Plots & Live Data -->

    <h2 id="plots">Plots &amp; Live Data</h2>

    <h3>Real-Time Plots</h3>
    <p>The Plot Panel displays live data with up to 4 configurable axes:</p>
    <ul>
        <li><b>Y (left axis):</b> Primary parameter</li>
        <li><b>Y1, Y2, Y3 (right axes):</b> Additional parameters with independent scales</li>
        <li><b>X axis:</b> Time, Capacity, Energy, or any measured parameter</li>
    </ul>
    <p><b>Parameters:</b> Voltage, Current, Power, Load R, Battery R, MOSFET Temp, External Temp, Capacity, Energy</p>
    <p>Features auto-scaling with SI prefixes, adjustable time windows (30s to All), interactive zoom/pan, and point markers.</p>

    <h3>Status Panel</h3>
    <p>Displays live readings: voltage, current, power, capacity (mAh), energy (Wh),
    MOSFET and external temperatures, fan speed, load and battery resistance, and elapsed time.</p>

    <hr>

    <!-- Data Management -->

    <h2 id="data">Data Management</h2>

    <h3>Logging</h3>
    <ul>
        <li>Toggle with the <b>Log Data</b> switch in the Status Panel</li>
        <li>Records at 1 Hz to both SQLite database and in-memory buffer (last 48 hours)</li>
    </ul>

    <h3>Saving &amp; Exporting</h3>
    <ul>
        <li><b>Auto-save:</b> Enable in test panels — saves JSON when test completes</li>
        <li><b>Manual save:</b> Click <b>Save</b> for a custom filename</li>
        <li><b>Export:</b> CSV and Excel formats available</li>
        <li><b>Location:</b> See Settings → Database for the data directory</li>
    </ul>

    <h3>History Panel</h3>
    <p>Browse and reload saved test data. Click any file to load it into the plot and test panel.
    Use <b>Show Folder</b> to open the data directory.</p>

    <h3>Database Management</h3>
    <p>Access via <b>Tools → Database Management</b> to view statistics or purge old data.</p>

    <div class="callout warning">
        <b>Warning:</b> Database purge is permanent. Exported JSON/CSV files are not affected.
    </div>

    <hr>

    <!-- Presets -->

    <h2 id="presets">Presets</h2>
    <ul>
        <li><b>Battery presets:</b> Common batteries with chemistry, voltage, and capacity pre-filled (Canon, Nikon, Sony, Eneloop, etc.)</li>
        <li><b>Test presets:</b> Pre-configured test parameters for common scenarios</li>
        <li>Save your own with <b>Save</b>, delete user presets with <b>Delete</b></li>
        <li>Default presets cannot be deleted</li>
    </ul>

    <hr>

    <!-- Settings -->

    <h2 id="settings">Settings</h2>

    <table>
        <tr><th>Setting</th><th>Location</th><th>Description</th></tr>
        <tr><td>Auto-connect</td><td>File → Settings</td><td>Connect to DL24P automatically on startup</td></tr>
        <tr><td>Backlight</td><td>Device → Settings</td><td>Screen brightness and standby timeout</td></tr>
        <tr><td>Counter Reset</td><td>Device → Settings</td><td>Clear mAh, Wh, and time counters on device</td></tr>
        <tr><td>Factory Reset</td><td>Device → Settings</td><td>Restore device to default settings</td></tr>
        <tr><td>Tooltips</td><td>Help → Show Tooltips</td><td>Toggle hover help throughout the app</td></tr>
    </table>

    <hr>

    <!-- Battery Chemistry Reference -->

    <h2 id="chemistry">Battery Chemistry Reference</h2>

    <table>
        <tr><th>Chemistry</th><th>Nominal V</th><th>Cutoff V</th><th>Full V</th></tr>
        <tr><td>Li-Ion / LiPo</td><td>3.7V</td><td>2.5–3.0V</td><td>4.2V</td></tr>
        <tr><td>LiFePO4</td><td>3.2V</td><td>2.5V</td><td>3.65V</td></tr>
        <tr><td>NiMH</td><td>1.2V</td><td>0.9–1.0V</td><td>1.45V</td></tr>
        <tr><td>NiCd</td><td>1.2V</td><td>0.9–1.0V</td><td>1.45V</td></tr>
        <tr><td>Lead Acid</td><td>2.0V/cell</td><td>1.75V/cell</td><td>2.4V/cell</td></tr>
    </table>

    <hr>

    <!-- Technical Specifications -->

    <h2 id="specs">Technical Specifications</h2>

    <table>
        <tr><th>Parameter</th><th>Value</th></tr>
        <tr><td>Voltage range</td><td>0–30V</td></tr>
        <tr><td>Current range</td><td>0–24A</td></tr>
        <tr><td>Power (max)</td><td>150W (with active cooling)</td></tr>
        <tr><td>Modes</td><td>CC, CP, CV, CR</td></tr>
        <tr><td>Resolution</td><td>10mV, 10mA</td></tr>
        <tr><td>Connection</td><td>USB HID (no drivers needed)</td></tr>
        <tr><td>Logging rate</td><td>1 Hz</td></tr>
        <tr><td>Database</td><td>SQLite 3</td></tr>
        <tr><td>Export formats</td><td>JSON, CSV, Excel</td></tr>
    </table>

    <hr>

    <!-- File Locations -->

    <h2 id="files">File Locations</h2>

    <table>
        <tr><th>Content</th><th>Path</th></tr>
        <tr><td>User data</td><td>See Settings → Database for the data directory</td></tr>
        <tr><td>Test results</td><td><code>test_data/</code> (within data directory)</td></tr>
        <tr><td>Database</td><td><code>tests.db</code> (within data directory)</td></tr>
        <tr><td>Session state</td><td><code>sessions/</code> (within data directory)</td></tr>
        <tr><td>User presets</td><td><code>presets/</code> (within data directory)</td></tr>
    </table>

    <hr>

    <!-- Troubleshooting -->

    <h2 id="troubleshooting">Troubleshooting</h2>

    <h3>Device Won't Connect</h3>
    <ul>
        <li>Check USB cable is fully seated — try a different cable or port</li>
        <li>Verify the DL24P screen is on and showing readings</li>
        <li>Close any other apps that might be using the device</li>
    </ul>

    <h3>Readings Stop Updating</h3>
    <ul>
        <li>macOS may suspend USB devices during sleep — unplug and replug the cable</li>
        <li>Use <b>Reset</b> button or disconnect/reconnect</li>
        <li>Keep display sleep disabled during long tests</li>
    </ul>

    <h3>Live Readings Stop Updating (Detailed)</h3>

    <div class="callout problem">
        <b>Symptom:</b> The device is connected and can be controlled (load on/off works),
        but Live Readings (voltage, current, power) stop updating.
    </div>

    <h3>Root Cause</h3>
    <p>This is a <b>known issue with macOS USB HID drivers</b>, particularly when:</p>
    <ul>
        <li>The Mac goes to sleep or the display turns off</li>
        <li>macOS suspends USB devices for power management</li>
        <li>The USB HID driver enters a stuck state where commands are sent but responses aren't received</li>
    </ul>

    <h3>Solutions (Try in Order)</h3>

    <div class="callout solution">
        <b>1. Click the Reset Button</b>
        <ul>
            <li>Click the <code>Reset</code> button next to the Disconnect button</li>
            <li>This disconnects and reconnects after a 2-second delay</li>
            <li>Works in some cases, but not always due to macOS driver limitations</li>
        </ul>
    </div>

    <div class="callout solution">
        <b>2. Manual Disconnect/Reconnect</b>
        <ul>
            <li>Click <code>Disconnect</code></li>
            <li>Wait 2-3 seconds</li>
            <li>Click <code>Connect</code></li>
            <li>Same as Reset button, but with manual control over timing</li>
        </ul>
    </div>

    <div class="callout solution">
        <b>3. Unplug and Replug USB Cable (Most Reliable)</b>
        <ul>
            <li>Physically unplug the USB cable from the DL24P or computer</li>
            <li>Wait 2-3 seconds</li>
            <li>Plug it back in</li>
            <li>Click <code>Connect</code> in the app</li>
            <li><b>This is the most reliable solution</b> for stuck USB HID states</li>
        </ul>
    </div>

    <h3>Why Software Reset Doesn't Always Work</h3>
    <p>Research shows this is a limitation of the hidapi library and macOS USB HID drivers:</p>
    <ul>
        <li><b>macOS Power Management:</b> When the Mac sleeps, USB devices may not properly wake up
            (<a href="https://kb.plugable.com/docking-stations-and-video/devices-are-not-detected-after-waking-from-sleep-or-after-rebooting-on-macos">Plugable KB Article</a>)</li>
        <li><b>HID Driver State:</b> The IOHIDDevice can get stuck in a state where closing and reopening
            doesn't clear pending operations (<a href="https://github.com/libusb/hidapi/issues/171">hidapi Issue #171</a>)</li>
        <li><b>No Reset Function:</b> There's no programmatic way to reset IOHIDDevice state — physical
            disconnect is required (<a href="https://github.com/signal11/hidapi/issues/114">hidapi Issue #114</a>)</li>
    </ul>

    <h3>Prevention Tips</h3>
    <div class="callout info">
        <ul>
            <li><b>Prevent Mac Sleep:</b> System Settings → Battery → Prevent automatic sleeping when display is off</li>
            <li><b>Use a USB Hub:</b> Some users report better reliability with powered USB hubs</li>
            <li><b>Avoid USB-C Adapters:</b> Direct USB-A connection may be more stable</li>
            <li><b>Keep App Active:</b> Minimize display sleep timeout while running tests</li>
        </ul>
    </div>

    <h3>Test Stops Prematurely</h3>
    <ul>
        <li>Voltage cutoff was reached (check the plot)</li>
        <li>Time limit expired</li>
        <li>DL24P overheated (check MOSFET temperature — device has thermal protection)</li>
    </ul>

    <h3>Connection Error</h3>
    <ul>
        <li>Close any other apps that might be using the DL24P</li>
        <li>Restart the Test Bench app</li>
        <li>Try unplugging/replugging USB cable</li>
    </ul>

    <h3>Debug Logging</h3>
    <p>Enable <b>Debug Log</b> checkbox in the Control Panel to see detailed USB communication
    in <code>debug.log</code>. Look for "No response received" warnings to confirm the stuck state issue.</p>

    <hr>

    <p class="footer">
        Load Test Bench &nbsp;&middot;&nbsp; Built with PySide6 and pyqtgraph<br>
        <a href="https://github.com/nevetssf/aTorch-DL24P">github.com/nevetssf/aTorch-DL24P</a>
    </p>
</body>
</html>
